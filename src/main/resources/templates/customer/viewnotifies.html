<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Thông báo</title>
    <!-- Phải thêm popper để không bị lỗi dropdown-menu -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        body { background-color: #f8f9fa  }
        .book-card {
            margin-bottom: 20px;
            margin-top: 20px;
        }
        .book-card .card-img {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .card.book-card {
            border: 1px solid rgb(182,232,241);
            border-radius: 20px
        }
        .card.book-card:hover {
            background-color: azure;
        }
        .flex-item {
            display: flex;
            flex: 1 0 auto;
        }
        .outer-frame {
            width: 340px;
            height: 300px;
            border: 1px solid rgb(255, 255, 255);
            padding: 10px;
            margin: 10px 10px 10px 10px;
            border-radius: 10px;
        }
        .btn-see-details:hover {
            color: rgb(182,232,241);
        }
        .card-title a {
            color: rgb(0, 0, 128);
            text-align: center;
        }
        .btn-see-details{
            background-color: rgb(2,88,155);
            color: rgb(255, 255, 255);
            border: 1px rgb(2,88,155);
            border-radius: 10px
        }
        .btn-outline {
            border-radius: 10px;
            color: black;
            background-color: white;
        }
        .btn-outline:hover {
                color:rgb(2,88,155); /* Thay đổi màu văn bản khi trỏ chuột vào nút */
        }
        .form-control:focus {
            width: 700px; /* Thay 500px bằng độ dài bạn muốn */
            height: 45px;
            border-radius: 10px
        }

        .btn-catalog {
            background-color: rgb(2,88,155);
            color: rgb(255, 255, 255);
            border: 1px rgb(2,88,155);
            border-radius: 5px;
            height: 45px;
            border-radius: 10px
        }
        .btn-catalog:hover {
            color: rgb(182,232,241);
        }

        .frame-main {
            margin-bottom: 10px;
            margin-right: 10px;
        }

        h3 {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 20px;
            color: rgb(2,88,155);
        }
        .page-link {
            border: 1px solid rgb(182,232,241);
        }

        .frame-number {
            display: flex;
            justify-content: center;
            border-radius: 20px
        }
        .col-price {
            margin-bottom: 20px;
            text-align: justify;
        }


        .row-image-intro {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .col-image {
            padding: 5px;  /* Điều chỉnh khoảng cách giữa các cột ở đây */
            margin-left: 10px;

        }

        .card-image {
            width: 230px; /* Điều chỉnh chiều rộng ở đây */
            height: 260px; /* Điều chỉnh chiều cao ở đây */
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            margin-top: 10px;
            margin-bottom: 10px;
            margin-left: 10px;
            margin-right: 10px;
        }

        .frame-intro {
            border: 1px solid rgb(182,232,241);
            display: flex;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 20px;
        }
        .frame-intro:hover {
            background-color: azure;
        }
        .row{
            margin-top: 10px;
        }

        .container.main {
            border: 2px ;
            border-radius: 5px;
            border-radius: 15px;
            padding: 15px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .carousel-inner {
          border-radius: 20px;
          width: 810px; /* Chiều rộng cố định */
          height: 400px; /* Chiều cao cố định */
        }

        .carousel-inner img {
          width: 100%; /* Chiều rộng của ảnh bằng với chiều rộng của khung */
          height: 100%; /* Chiều cao của ảnh bằng với chiều cao của khung */
          object-fit: cover; /* Ảnh sẽ được co dãn để vừa với khung mà không làm thay đổi tỷ lệ */
        }

        .no-bullets {
            list-style-type: none;
            text-align: le;
        }

        .dropdown.open{
            list-style-type: none;
        }

        .level-0 {
            font-family: Arial, sans-serif;
            padding: 9px 15px;

        }
        .level-0:hover {
            color: rgb(2,88,155);
            background-color: aliceblue;
            border-radius: 10px;
        }

        a {
            color: black;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        a:hover {
            text-decoration: none;
            color: rgb(2,88,155);
        }

        h5 {
            text-align: left;
            margin-top: 10px;
            margin-bottom: 20px;
            color: #211f7f;
        }

         h5.frame {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 20px;
            color: #211f7f;
        }

        .navbar-nav {
            display: frex;
        }
        .navbar-nav-left {
            width: 70%;
        }
        .navbar-nav-right {
            width: 30%;
        }
        .nav-link {
            display: flex;
              align-items: center;
              column-gap: 0.5rem;
              width: fit-content;
        }
        .move-right {
            margin-left: auto;
            display: flex;
            float: right;
        }
        .material-symbols-outlined{
            color: rgb(2,88,155);
        }

        .product.images-container{
            width: 120px;
            height: 200px;
        }

        .item-inner {
            margin-bottom: 30px;
        }

        .ma-box-content {
            border-radius: 5px;
            padding: 10px;
        }

        .ma-box-content:hover {
            box-shadow: 0 3px 5px rgb(226, 226, 226);
            border: solid 1px rgb(226, 226, 226);
        }

        .col-image{
            border-radius: 20px;
            margin: 0px;
        }

        .col-image:hover {
            box-shadow: 3px 3px 5px 3px #F1F1CF;
        }


        .hidden-content {
            display: none;
        }
        .container.main {
            box-shadow: 0 8px 10px rgb(226, 226, 226);

        }

        .material-symbols-outlined.search{
            color: rgb(2,88,155);
        }

        .material-symbols-outlined.click{
            color: rgb(2,88,155);
        }
        .material-symbols-outlined.click:hover {
            color: rgb(182,232,241);
        }

        .page-link {
            height: 40px;
            color: rgb(2,88,155);
            border: #f8f9fa;
            border-radius: 10px !important;
            margin: 2px;
        }
        .page-item.active .page-link {
            background-color: #e0f3ff;
            color: rgb(2,88,155);
        }

        .page-link:hover {
            background-color: #e0f3ff;
        }


        .modal {
          display: none;
          position: fixed;
          z-index: 2;

          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgb(0,0,0);
          background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
            width: auto;
            max-width: 800px;
        }

        .close {
          position: absolute;
          top: 15px;
          right: 35px;
          color: #f1f1f1;
          font-size: 40px;
          font-weight: bold;
          transition: 0.3s;
        }

        .close:hover,
        .close:focus {
          color: #bbb;
          text-decoration: none;
          cursor: pointer;
        }

        .card-image {
          cursor: pointer;
        }

        .row{
            position: relative;
              z-index: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 1;
            transition: opacity 0.5s ease;
            z-index: 9999; /* Đảm bảo thông báo hiển thị trên cùng */
            width: auto; /* Đảm bảo thông báo co dãn tự động theo nội dung */
            white-space: nowrap; /* Ngăn chặn trường hợp nội dung quá dài bị ngắt dòng */
        }

        .material-symbols-outlined.shopping-bag {
            color: grey;
        }

        .material-symbols-outlined.shopping-bag:hover {
            color: rgb(2,88,155);
        }

        .alert-success {
            color: rgb(91,181,111);
        }
        .alert-danger {
            color: rgb(247,80,80);
        }

        .button-shop-now{
            height: 50px;
            width: 150px;
            border-radius: 50px;
            border: none;
            background-color: white;
            color: rgb(2,88,155);
            font-style: Palatino;
            font-weight: bold;
            font-size: 18px;
        }

<<<<<<< Updated upstream
        .container-body {
             width: 100%;
             border-radius: 15px;
             margin: 40px auto;
             box-shadow: 0 8px 10px rgb(226, 226, 226);
             background-color: white;
        }

=======
        /* CSS */
        .notification {
            visibility: hidden;
            max-width: 50px;
            height: 50px;
            line-height: 50px;
            border-radius: 15px;
            background-color: #329932;
            color: white;
            text-align: center;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            margin-left: -125px;
        }
        .notification.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
>>>>>>> Stashed changes
        .btn-tick:hover {
            background-color: #5390f5;
            color: white;
        }

        .btn-detail:hover {
            background-color: #5390f5;
            color: white;
        }
    </style>
</head>
<!--Phần Chat Box -->
<script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
<df-messenger
        intent="WELCOME"
        chat-title="tu-van-ban-sach"
        agent-id="3481f35a-a856-4b10-94ed-2b03e01edd5f"
        language-code="vi"
></df-messenger>
<body>
<div th:replace="~{layout/header :: header}"></div>

<!-- Hiển thị thông báo từ redirect nếu có -->
<div th:if="${message}" class="alert"
     th:classappend="${message.contains('thành công') ? 'alert-success' : 'alert-danger'}"
     th:text="${message}" style="font-weight: bold;justify-content: center; display: flex">
</div>


<!-- Danh sách thông báo -->
<div class="container" >
<!--    <div class="form-container">-->
<!--        &lt;!&ndash;Thông báo từ lớp Notification &ndash;&gt;-->
<!--        <div th:if="${session.account != null}" th:replace="~{customer/notify :: notify}"></div>-->
<!--    </div>-->

    <div class="form-container" style="background-color: white; padding: 20px; border-radius: 15px; margin: 40px 0px; box-shadow: 0 4px 8px rgb(226, 226, 226);">
            <h6 style="color: #211f7f; align-items: center;  margin: 0px 5px 0px 0px; padding: 0px 0px 20px 20px; font-family: Verdana; font-weight: bold">Thông báo</h6>

        <div class="row-01 d-flex align-items-center" style="justify-content: flex-end; padding-right: 20px">
            <a id="mark-all-read-btn" onclick="markAllAsRead(this)" class="btn btn-detail"
               onmouseover="this.style.backgroundColor='#5390f5'; this.style.color='white';"
               onmouseout="this.style.backgroundColor='white'; this.style.color='#5390f5';"
               style="border-radius: 50px; background-color: white; color: #5390f5;  border: 1px solid #5390f5; width: 170px; height: 40px; margin-bottom: 15px">Đánh dấu tất cả</a>
        </div>

        <th:block th:each="notification : ${notifications.content}">
            <div  onmouseover="this.style.backgroundColor='#f2f8f8';"
                  onmouseout="this.style.backgroundColor='transparent';"
                   class="card" style="width: 100%; border-radius: 15px; border: none;">
                <div class="card-body">
                    <div class="row-announce d-flex align-items-center" style="width: 100%; ">
                        <div class="col-10 d-flex" style="width: 90%; padding: 0px 20px 0px 0px">
                            <img src="https://res.cloudinary.com/dylwewmt0/image/upload/v1717046493/PHOTO_LIST/Notifications/01.png" alt="Knowledge Young" style="width:50px;">
                            <div class="row-01">
                                <span th:text="${#temporals.format(notification.sentTime.toLocalDateTime(), 'dd/MM/yyyy')}" style="color: grey; font-family: 'Museo Moderno', sans-serif;"></span>
                                <p class="card-text" th:text="${notification.content}" style="font-family: 'Museo Moderno', sans-serif;">Nội dung thông báo</p>
                            </div>
                        </div>
                        <div class="col-2 align-items-center justify-content-center" style="display-direction: column; width: 10%; padding: 0px">
                            <!-- Nếu type = 0, hiển thị nút xem chi tiết đơn hàng -->
                            <a th:if="${notification.type == 0}" class="btn btn-detail"
                               th:href="@{/vieworderitems(orderId=${notification.referredId})}"
                               th:data-id="${notification.id}" th:onclick="markAsReadAndRedirect(this)"
                               onmouseover="this.style.backgroundColor='#5390f5'; this.style.color='white';"
                               onmouseout="this.style.backgroundColor='white'; this.style.color='#5390f5';"
                               style="border-radius: 50px; background-color: white; color: #5390f5;  border: 1px solid #5390f5; width: 170px; height: 40px">
                                Xem chi tiết
                            </a>

                            <!-- Nếu type = 1, hiển thị nút xem chi tiết sách -->
                            <a th:if="${notification.type == 1}" class="btn btn-detail"
                               th:href="@{/detailbook/{id}(id=${notification.referredId})}"
                               th:data-id="${notification.id}" th:onclick="markAsReadAndRedirect(this)"
                               onmouseover="this.style.backgroundColor='#5390f5'; this.style.color='white';"
                               onmouseout="this.style.backgroundColor='white'; this.style.color='#5390f5';"
                               style="border-radius: 50px; background-color: white; color: #5390f5; border: 1px solid #5390f5; width: 170px; height: 40px">
                                Xem chi tiết
                            </a>
                            <div class="row-tick" style=" display-direction: column">
                                <!-- Nút đánh dấu đã đọc -->
                                <a th:if="${notification.status == 0}" href="#" th:id="'mark-as-read-' + ${notification.id}" class="btn btn-tick" th:onclick="'markNotifyAsRead(' + ${notification.id} + ', event)'"
                                   onmouseover="this.style.backgroundColor='#5390f5'; this.style.color='white';"
                                   onmouseout="this.style.backgroundColor='white'; this.style.color='#5390f5';"
                                   style="border-radius: 50px; margin-top: 15px; background-color: white; color: #5390f5; border: 1px solid #5390f5; width: 170px; height: 40px">
                                    Đánh dấu đã đọc
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </th:block>
        <!--Phần phân trang-->
        <div class="frame-number d-flex align-items-center" style="margin-top: 15px">
            <div th:if="${notifications.totalPages > 1}">
                <ul class="pagination">
                    <li th:if="${notifications.hasPrevious()}" class="page-item">
                        <a class="page-link" th:href="@{/viewnotifications(page=${notifications.number})}">
                            <span class="material-symbols-outlined">navigate_before</span>
                        </a>
                    </li>

                    <th:block th:each="pageNumber : ${#numbers.sequence(0, notifications.totalPages - 1)}">
                        <li class="page-item" th:classappend="${pageNumber == notifications.number ? 'active' : ''}">
                            <th:block th:if="${pageNumber == notifications.number}">
                                <span class="page-link" th:text="${pageNumber + 1}"></span>
                            </th:block>
                            <th:block th:unless="${pageNumber == notifications.number}">
                                <a class="page-link" th:href="@{/viewnotifications(page=${pageNumber + 1})}" th:text="${pageNumber + 1}"></a>
                            </th:block>
                        </li>
                    </th:block>

                    <li th:if="${notifications.hasNext()}" class="page-item">
                        <a class="page-link" th:href="@{/viewnotifications(page=${notifications.number + 2})}">
                            <span class="material-symbols-outlined">navigate_next</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{layout/footer :: footer}"></div>
<!-- Thêm các tệp tin JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <!-- Để xài ajax -->
<script th:src="@{/js/popper.min.js}"></script>
<script th:src="@{/js/bootstrap.min.js}"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
    // Nút xem chi tiết (đánh dấu đã đọc và chuyển đến trang chi tiết)
    function markAsReadAndRedirect(element) {
        var notificationId = element.getAttribute('data-id');
        var redirectUrl = element.getAttribute('href');

        // Ẩn nút "Đánh dấu đã đọc" ngay lập tức
        var markAsReadButton = document.getElementById('mark-as-read-' + notificationId);
        if (markAsReadButton) {
            markAsReadButton.style.display = 'none';
        }

        // Gửi yêu cầu GET đến máy chủ để đánh dấu thông báo là đã đọc
        fetch('http://localhost:8080/webbookstore/marknotifyasread/' + notificationId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: notificationId }),
        })
        .then(response => {
            if (response.ok) {
                console.log('Notification marked as read on server');
                // Chuyển hướng sau khi đánh dấu thành công
                window.location.href = redirectUrl;
            } else {
                console.error('Error:', response.status);
                // Nếu có lỗi, hiển thị lại nút "Đánh dấu đã đọc"
                if (markAsReadButton) {
                    markAsReadButton.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Nếu có lỗi, hiển thị lại nút "Đánh dấu đã đọc"
            if (markAsReadButton) {
                markAsReadButton.style.display = 'block';
            }
        });
    }


    // Nút đánh dấu đã đọc
    function markNotifyAsRead(notificationId, event) {
        // Ngăn chặn hành động mặc định của thẻ <a>
        event.preventDefault();

        // Ẩn nút "Đánh dấu đã đọc" ngay lập tức
        var markAsReadButton = document.getElementById('mark-as-read-' + notificationId);
        if (markAsReadButton) {
            markAsReadButton.style.display = 'none';
        }

        // Sau đó gửi yêu cầu đến máy chủ để xử lý
        fetch('http://localhost:8080/webbookstore/marknotifyasread/' + notificationId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: notificationId }),
        })
        .then(response => {
            if (response.ok) {
                console.log('Notification marked as read on server');
            } else {
                console.error('Error:', response.status);
                // Nếu có lỗi, hiển thị lại nút "Đánh dấu đã đọc"
                if (markAsReadButton) {
                    markAsReadButton.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Nếu có lỗi, hiển thị lại nút "Đánh dấu đã đọc"
            if (markAsReadButton) {
                markAsReadButton.style.display = 'block';
            }
        });
    }

    // Nút đánh dấu tất cả đã đọc
    function markAllAsRead(button) {
        button.innerHTML = "Đang xử lý..."; // Thay đổi nội dung nút

        fetch('http://localhost:8080/webbookstore/markallnotificationsasread', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Tải lại trang để cập nhật giao diện
            } else {
                console.error('Server responded with status:', response.status);
                document.getElementById('mark-all-read-btn').innerHTML = "Đánh dấu tất cả là đã đọc"; // Đổi lại nội dung nút nếu có lỗi
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('mark-all-read-btn').innerHTML = "Đánh dấu tất cả là đã đọc"; // Đổi lại nội dung nút nếu có lỗi
        });
    }
</script>
</body>
</html>

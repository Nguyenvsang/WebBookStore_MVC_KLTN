<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Giỏ hàng</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <style>
		
		body { background-color: #f8f9fa  }

		.material-symbols-outlined.search{
			color: rgb(2,88,155);
		}

    	h3 {
        	text-align: center;
        	margin-top: 3px;
        	margin-bottom: 20px;
        	color: rgb(2,88,155);       	
    	}		
		.thead-title {
		    border-radius: 25px;
		    overflow: hidden;
		    background-color: rgb(182,232,241);
			color: black;
			border-radius: 15px
		}
		
		.thead-title th:first-child {
		    border-top-left-radius: 15px;
		}
		
		.thead-title th:last-child {
		    border-top-right-radius: 15px;
		}
		
		.btn-purchase {
			background-color: #3448c5;
			border-radius: 50px;
			color: white;
			width: 100%;
			box-shadow: 0px 4px 6px rgba(0, 0.4, 0, 0.2);
		}
		.btn-purchase:hover {
			background-color: #211f7f;
			color: white;
			box-shadow: 0px 6px 8px rgba(0, 0.4, 0, 0.2);
		}
		
		
<!--		tbody tr:last-child td:first-child {-->
<!--		    border-bottom-left-radius: 15px;-->
<!--		}-->
<!--		-->
<!--		tbody tr:last-child td:last-child {-->
<!--		    border-bottom-right-radius: 15px;-->
<!--		}-->
<!--		.thead-title th:first-child {-->
<!--		    border-top-left-radius: 15px;-->
<!--		}-->
<!--		-->
<!--		.thead-title th:last-child {-->
<!--		    border-top-right-radius: 15px;-->
<!--		}-->


		.table {
		    border-radius: 15px;
		}

		.btn-outline {
			border-radius: 10px;
		}
		.btn-outline:hover {

		}
		
		.col-increase {
			align-items: center;
			margin-right: 20px;
		}
		
		.col-decrease {
			align-items: center;
			margin-left: 20px;
		}
		.form-control {
			border: none;
			width: 50px;

		}
<!--		table {-->
<!--        	border-collapse: collapse;-->
<!--	    }-->
<!--	    td {-->
<!--	        border: 1px solid rgb(242,242,242);-->
<!--	    }-->
	    .container-body {
	        padding: 20px;
        	margin-top: 40px;
        	margin-bottom: 40px;
        	border-radius: 15px;
        	background-color: white;
		}

		.container-body-01 {
	        padding: 20px;
        	margin-top: 40px;
        	margin-bottom: 40px;
        	border-radius: 15px;
        	background-color: white;
  			bottom: 0px;
  			box-shadow: 0 8px 10px rgb(226, 226, 226);
  			border: 0.5px solid #cecece;
  			position: sticky;
		}



		.text-right {
			margin: 20px;
		}
		
		.navbar-nav {
			display: frex;
		}
		.navbar-nav-left {
			width: 70%;
		}
		.navbar-nav-right {
			width: 30%;
		}
		.nav-link {
			display: flex;
      		align-items: center;
      		column-gap: 0.5rem;
      		width: fit-content;
		}
		.move-right {
			margin-left: auto;
			display: flex;
			float: right;
		}

		.container-body {
			box-shadow: 0 8px 10px rgb(226, 226, 226);
			
		}
		
		.material-symbols-outlined.delete {
			color: grey;
		}
		
		.material-symbols-outlined.delete:hover {
			color: rgb(2,88,155);
		}
		.all-delete{
			color: grey;
		}

		.form-cart-total-avail{
			color: orangered;
			margin-bottom: 30px;
			margin-top: 40px;
			text-align: center;
			justify-content: center;
			display: flex;
			border-radius: 10px;
			font-size: larger;
		}

		.form-cart-total-unavail{
			color: orangered;
			margin-bottom: 30px;
			margin-top: 40px;
			text-align: center;
			justify-content: center;
			display: flex;
			border-radius: 10px;
			font-size: larger;
		}

		.btn-continue {
				background-color: rgb(2,88,155);
				border-radius: 10px;
				color: white;
				margin-top: 30px;
				margin-bottom: 20px;
		}
		.btn-continue:hover {
			color: rgb(182,232,241)
		}

		.title-book{
			text-decoration: none;
			color: black;
			font-family: Helvetica;
		}

		.title-book:hover {
			text-decoration: none;
			color: #5390f5;
			font-weight: bold;
			font-family: Helvetica;
		}

		.TWLNg9 {
			padding: 3px 0;
		}
		.qJkRlY {
			background-image: repeating-linear-gradient(45deg,#6fa6d6,#6fa6d6 33px,transparent 0,transparent 41px,#f18d9b 0,#f18d9b 74px,transparent 0,transparent 82px);
			background-position-x: -1.875rem;
			background-size: 7.25rem .1875rem;
			height: .1875rem;
			width: 100%
		}

		.btn-continue {
			background-color: #3448c5;
			border-radius: 50px;
			color: white;
			width: 200px;
			box-shadow: 0px 4px 6px rgba(0, 0.4, 0, 0.2);
			font-weight: bold;
		}

		.btn-continue:hover {
			background-color: #211f7f;
			color: white;
			box-shadow: 0px 6px 8px rgba(0, 0.4, 0, 0.2);
			font-weight: bold;
		}

		button:focus {
			outline: none;
		}

		.delete-all{
			color: grey;
		}

		.delete-all:hover {
			color: rgb(2,88,155);
		}

		.alert-success {
			color: rgb(91,181,111);
		}
		.alert-danger {
			color: rgb(247,80,80);
		}


		<!--Vô hiệu hóa nút number-->

		/* Chrome, Safari, Edge, Opera */
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}

		/* Firefox */
		input[type=number] {
			-moz-appearance: textfield;
		}
	</style>
</head>
<body>
	<div th:replace="~{layout/header :: header}"></div>
	<!-- Hiển thị thông báo nếu có -->
	<div th:if="${param.message}" class="alert" id="myAlert02"
		 th:classappend="${#strings.containsIgnoreCase(param.message, 'thành công') ? 'alert-success' : 'alert-danger'}">
		<span th:text="${param.message}" style="font-weight: bold;justify-content: center; display: flex;"></span>
	</div>

	<!-- Hiển thị thông báo kiểu model nếu có (dùng khi giỏ hàng trống) -->

	<div th:if="${message}" class="alert" id="myAlert01"
		 th:classappend="${message.contains('thành công') ? 'alert-success' : 'alert-danger'}"
		 th:text="${message}" style="font-weight: bold;justify-content: center; display: flex">
	</div>


	<!-- Nếu giỏ hàng trống thì dẫn hướng về trang viewbooks -->
	<div class="container" th:if="${cartItems == null}" style="padding: 0px">
		<div class="container-body" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0px; height: 350px">
			<img src="https://res.cloudinary.com/dylwewmt0/image/upload/v1713857142/PHOTO_LIST/Cart/cart.jpg" alt="" style="width: 180px;">
			<div class="row d-flex align-items-center justify-content-center">
				<p style="margin: 0px; color: grey; font-weight: bold;">Chưa có sản phẩm trong giỏ hàng của bạn.</p>
			</div>
			<a class="btn btn-continue" th:href="@{/viewbooks}">Mua sắm ngay!</a>
		</div>
	</div>

	<div class="container-fluid mb-4" >
		<!--Đang chỉnh sửa add to cart-->
		<div th:if="${cartItems != null}" class="container">
			<div class="container-body" style="padding: 0px">
				<!--Hiển thị các món hàng còn hàng (nếu có)-->
				<div th:if="${!availableItems.isEmpty()}" class="col-00">
					<div class="row-cart d-flex align-items-center">
						<h6 style="color: #211f7f; align-items: center;  margin: 0px; padding: 20px 0px 0px 20px; font-family: Verdana; font-weight: bold">Giỏ hàng</h6>
						<div class="form-cart-total-avail" th:if="${totalAllAvailableCartItems != null}"
							 style="color: orangered; align-items: center;  margin: 0px 5px 0px 0px; padding: 20px 0px 0px 10px; font-weight: 500;">
							<p style="margin: 0px 0px 0px; font-family: Verdana; font-size: 15px">(<span th:text="${totalAllAvailableCartItems}"></span> quyển sách)</p>
						</div>
					</div>
					<div class="next-table only-bottom-border" style="margin-top: 20px">
						<div class="next-table-inner">
							<div class="next-table-header" style="height: 50px; border-top: 1px solid #cecece; background-color: #f2f5f6">
								<div class="next-table-header-inner">
									<table>
										<colgroup style="width: 1020px;">
											<col style="width: 7%;">
											<col style="width: 43%;">
											<col style="width: 20%;">
											<col style="width: 20%;">
											<col style="width: 10%;">

										</colgroup>
										<tbody>
										<tr>
											<th rowspan="1" class="next-table-header-node first" style="padding: 10px 20px;">
												<div class="next-table-cell-wrapper">
													<input type="checkbox" id="checkAll" style="width: 20px; height: 20px; margin: 4px 10px 4px 10px;">
												</div>
											</th>
											<th rowspan="1" class="next-table-header-node " style="padding: 10px 0px;">
												<div class="next-table-cell-wrapper">Tất cả quyển sách</div>
											</th>
											<th rowspan="1" class="next-table-header-node " style="padding: 10px 20px; text-align: center;">
												<div class="next-table-cell-wrapper">Số lượng</div>
											</th>
											<th rowspan="1" class="next-table-header-node " style="padding: 10px 20px; text-align: center">
												<div class="next-table-cell-wrapper">Thành tiền</div>
											</th>
											<th rowspan="1" class="next-table-header-node " style="padding: 10px 20px; text-align: center">
												<div class="next-table-cell-wrapper">Thao tác</div>
											</th>
										</tr>
										</tbody>
									</table>
								</div>
							</div>

							<div class="next-table-body">
								<table>
									<colgroup style="width: 1020px;">
										<col style="width: 7%;">
										<col style="width: 12%;">
										<col style="width: 31%;">
										<col style="width: 20%;">
										<col style="width: 20%;">
										<col style="width: 10%;">
									</colgroup>
									<tbody>
									<tr th:each="cartItem : ${availableItems}" style="border-top: 1px solid #cecece;" onmouseover="this.style.backgroundColor='#f2f5f6';" onmouseout="this.style.backgroundColor='transparent';">

										<td rowspan="1" class="next-table-header-node first " style="padding: 20px 20px;">
											<input type="checkbox" class="itemCheckbox" th:data-item-id="${cartItem.id}"
												   th:attr="data-cart-item-type='Available'"
												   th:data-price="${cartItem.book.currentDiscount != null ? cartItem.book.currentDiscount.discountedPrice : cartItem.book.sellPrice}"
												   th:data-quantity="${cartItem.quantity}" style="width: 20px; height: 20px; margin: 10px;">
										</td>

										<td rowspan="1" class="next-table-header-node" style="padding: 20px 20px;">
											<a th:href="@{/detailbook/{id} (id=${cartItem.book.id})}">
												<img th:src="${cartItem.book.bookImages[0].path}" style="width: 100px;">
											</a>
										</td>

										<td rowspan="1" class="next-table-header-node" style="padding: 20px 20px; display: flex; flex-direction: column; justify-content: space-between; height: 190px">
											<div class="row-book" style="height: 160px; text-decoration: none">
												<a href="#" class="title-book" th:href="@{/detailbook/{id} (id=${cartItem.book.id})}">
													<span th:if="${#strings.length(cartItem.book.name) > 100}" th:text="${#strings.substring(cartItem.book.name, 0, 100) + '...'}"></span>
													<span th:if="${#strings.length(cartItem.book.name) <= 100}" th:text="${cartItem.book.name}"></span>
												</a>
											</div>
											<div class="row-price-book" style="height: 30px; font-weight: bold;">
												<span th:text="${#numbers.formatInteger(cartItem.book.sellPrice, 0, 'POINT')+ ' đ'}"></span>
												<span th:if="${cartItem.book.currentDiscount != null}" th:text="'-' + ${cartItem.book.currentDiscount.discountPercent} +'%'" ></span>
												<span th:if="${cartItem.book.currentDiscount != null}" th:text="${#numbers.formatInteger(cartItem.book.currentDiscount.discountedPrice, 0, 'POINT')+ ' đ'}"></span>
											</div>
										</td>


										<td rowspan="1" class="next-table-header-node" style="padding: 10px 20px;">
											<div class="input-group justify-content-center">
												<div class="row d-flex align-items-center justify-content-center"
													 style="background: white; border-radius: 50px; border: 1px solid #cecece">
													<div class="col-decrease">
														<div class="input-group">
															<a class="outline" type="button" th:onclick="'decreaseQuantity(' + ${cartItem.id} + ')'" style="align-items: center; justify-items: center; display: flex;">
																<span class="material-symbols-outlined" style="color: grey; font-weight: bold; font-size: small">remove</span></a>
														</div>
													</div>
													<div class="col">
                                                        <input type="number" pattern="^[0-9]*$" class="form-control item-quantity" th:value="${cartItem.quantity}" th:id="'quantity_' + ${cartItem.id}"
                                                               th:data-item-id="${cartItem.id}" th:data-max-quantity="${cartItem.book.quantity}"
                                                               th:data-old-quantity="${cartItem.quantity}" style="text-align: center;">
													</div>
													<div class="col-increase">
														<div class="input-group">
															<a class="outline" type="button" th:onclick="'increaseQuantity(' + ${cartItem.id} + ', ' + ${cartItem.book.quantity} + ')'" style="align-items: center; justify-items: center; display: flex;">
																<span class="material-symbols-outlined" style="color: grey; font-weight: bold; font-size: small">add</span></a>
														</div>
													</div>
												</div>
											</div>
										</td>

										<td rowspan="1" class="next-table-header-node" style="padding: 10px 20px; text-align: right; color: orangered; font-weight: bold;" th:id="'totalpriceitem_' + ${cartItem.id}">
											<span th:if="${cartItem.book.currentDiscount != null}" th:text="${#numbers.formatInteger(cartItem.quantity * cartItem.book.currentDiscount.discountedPrice, 0, 'POINT')+ ' đ'}"></span>
											<span th:if="${cartItem.book.currentDiscount == null}" th:text="${#numbers.formatInteger(cartItem.quantity * cartItem.book.sellPrice, 0, 'POINT')+ ' đ'}"></span>
										</td>

										<td rowspan="1" class="next-table-header-node last" style="padding: 10px 20px; text-align: center" >
											<span class="delete-btn" th:attr="data-cart-item-type='Available', data-cart-item-id=${cartItem.id}" style="cursor: pointer;">
												<span class="material-symbols-outlined delete">delete</span>
											</span>
										</td>
									</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!--Hiển thị các món hàng không có sẵn-->
				<div th:if="${!unavailableItems.isEmpty()}" style="color: #333333">
					<div class="TWLNg9" style="padding: 40px 0px 20px">
						<div class="qJkRlY"></div>
					</div>
				</div>
				<div th:if="${!unavailableItems.isEmpty()}" class="col-00">
					<div class="row-cart d-flex align-items-center">
						<h6 style="color: #211f7f; align-items: center;  margin: 0px; padding: 20px 0px 0px 20px; font-family: Verdana; font-weight: bold">Sản phẩm không có sẵn</h6>
						<div class="form-cart-total-unavail" th:if="${unavailableItems.size() != 0}"
							 style="color: orangered; align-items: center;  margin: 0px 5px 0px 0px; padding: 20px 0px 0px 10px; font-weight: 500;">
							<p style="margin: 0px 0px 0px; font-family: Verdana; font-size: 15px">(<span th:text="${unavailableItems.size()}"></span> quyển sách)</p>
						</div>
					</div>
					<div class="next-table only-bottom-border" style="margin-top: 20px">
						<div class="next-table-inner">
							<div class="next-table-header" style="height: 50px; border-top: 1px solid #cecece; background-color: #f2f5f6">
								<div class="next-table-header-inner" style="height: 50px;">
									<table>
										<colgroup style="width: 1020px;">
											<col style="width: 50%;">
											<col style="width: 20%;">
											<col style="width: 20%;">
											<col style="width: 10%;">

										</colgroup>
										<tbody>
										<tr>
											<th rowspan="1" class="next-table-header-node first d-flex align-items-center" style="padding: 0px 20px; height: 50px; color: grey">
												<form th:action="@{/removeallfromcart}" method="post">
													<input type="hidden" name="itemIds" th:value="${unavailableItemIdsString}" />
													<button type="submit" class="d-flex align-items-center" onmouseover="this.style.color='rgb(2,88,155)';"
															onmouseout="this.style.color='grey';" style="padding: 0; border: none; background: none; font-weight: bold; color: grey">
														<span class="material-symbols-outlined d-flex align-items-center" style="margin: 0px 20px 0px 5px">delete</span>
														Xóa tất cả
													</button>
												</form>
											</th>
											<th rowspan="1" class="next-table-header-node " style="padding: 0px 20px; text-align: center; height: 50px;">
												<div class="next-table-cell-wrapper">Số lượng</div>
											</th>
											<th rowspan="1" class="next-table-header-node " style="padding: 0px 20px; text-align: right; height: 50px;">
												<div class="next-table-cell-wrapper">Thành tiền</div>
											</th>
											<th rowspan="1" class="next-table-header-node last" style="padding: 0px 20px; text-align: center; height: 50px;">
												<div class="next-table-cell-wrapper">Thao tác</div>
											</th>
										</tr>
										</tbody>
									</table>
								</div>
							</div>

							<div class="next-table-body">
								<table>
									<colgroup style="width: 1020px;">
										<col style="width: 7%;">
										<col style="width: 12%;">
										<col style="width: 31%;">
										<col style="width: 20%;">
										<col style="width: 20%;">
										<col style="width: 10%;">
									</colgroup>
									<tbody>
									<tr th:each="cartItem : ${unavailableItems}" style="border-top: 1px solid #cecece;" onmouseover="this.style.backgroundColor='#f2f5f6';" onmouseout="this.style.backgroundColor='transparent';">

										<td rowspan="1" class="next-table-header-node first " style="padding: 20px 20px;">
											<div class="text-center"><span class="material-symbols-outlined" style="color: grey">disabled_by_default</span></div>
										</td>

										<td rowspan="1" class="next-table-header-node" style="padding: 20px 20px;">
											<a th:href="@{/detailbook/{id} (id=${cartItem.book.id})}">
												<img th:src="${cartItem.book.bookImages[0].path}" style="width: 100px;">
											</a>
										</td>

										<td rowspan="1" class="next-table-header-node" style="padding: 20px 20px; display: flex; flex-direction: column; justify-content: space-between; height: 190px">
											<div class="row-book" style="height: 160px; text-decoration: none" >
												<a href="#" class="title-book" th:href="@{/detailbook/{id} (id=${cartItem.book.id})}">
													<span th:if="${#strings.length(cartItem.book.name) > 100}" th:text="${#strings.substring(cartItem.book.name, 0, 100) + '...'}"></span>
													<span th:if="${#strings.length(cartItem.book.name) <= 100}" th:text="${cartItem.book.name}"></span>
												</a>
											</div>
											<div class="row-price-book" style="height: 30px; font-weight: bold;">
												<span th:text="${#numbers.formatInteger(cartItem.book.sellPrice, 0, 'POINT')+ ' đ'}"></span>
											</div>
										</td>


										<td rowspan="1" class="next-table-header-node" style="padding: 10px 20px;  text-align: center;">
											<span th:text="${cartItem.quantity}"></span>
										</td>

										<td rowspan="1" class="next-table-header-node" style="padding: 10px 20px; text-align: right; color: orangered; font-weight: bold;" th:id="'totalpriceitem_' + ${cartItem.id}" th:text="${#numbers.formatInteger(cartItem.quantity * cartItem.book.sellPrice, 0, 'POINT')+ ' đ'}"></td>

										<td rowspan="1" class="next-table-header-node last" style="padding: 10px 20px; text-align: center" >
											<span class="delete-btn" th:attr="data-cart-item-type='Unavailable', data-cart-item-id=${cartItem.id}" style="cursor: pointer;">
												<span class="material-symbols-outlined delete">delete</span>
											</span>
										</td>
									</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
				<!--Kết thúc hiển thị các món hàng hết hàng (nếu có)-->

			</div>
			<div th:if="${!availableItems.isEmpty()}" class="container-body-01" style="padding: 20px 20px 10px 20px;">
				<div class="row-voucher" style="border-bottom: 1px solid #cecece; padding: 0px 0px 10px; margin: 0px">
					<h6 style="text-align: right; color: #211f7f;">Chọn hoặc nhập mã</h6>
				</div>
				<div class="row-payment d-flex align-items-center justify-content-center" style="padding: 10px 0px 0px 0px;">
					<div class="next-table-body">
						<table>
							<colgroup style="width: 1020px;">
								<col style="width: 20%">
								<col style="width: 16%;">
								<col style="width: 16%;">
								<col style="width: 16%;">
								<col style="width: 16%;">
								<col style="width: 16%;">
							</colgroup>
							<tbody>
							<tr>
								<td rowspan="1" class="next-table-header-node first d-flex align-items-center justify-content-center" style="padding: 20px 20px 20px 0px; height: 77.6px">
									<input type="checkbox" id="check-All" style="width: 20px; height: 20px; margin-right: 20px; margin-bottom: 8px">
									<h6 style="margin: 0px 70px 8px 0px;">Chọn tất cả</h6>
								</td>
								<td rowspan="1" class="next-table-header-node" style="padding: 20px 20px;">
									<form th:action="@{/removeallfromcart}" method="post" id="delete-all">
										<input type="hidden" name="itemIds" value="all" />
										<button type="submit" class="d-flex align-items-center"  onmouseover="this.style.color='rgb(2,88,155)';"
												onmouseout="this.style.color='grey';" style="padding: 0; border: none; background: none; font-weight: bold; color: grey">
											<span class="material-symbols-outlined d-flex align-items-center" style="margin: 0px 20px 0px 5px;">delete</span>
											Xóa tất cả
										</button>
									</form>
								</td>
								<td rowspan="1" class="next-table-header-node" style="padding: 20px 0px 20px 0px; text-align: right">
									<!--Dùng Javascript document.getElementById('deleteSelected') để xử lý-->
									<button id="deleteSelected" class="btn btn-danger">Xóa</button>
								</td>
								<td rowspan="1" class="next-table-header-node" style="padding: 20px 0px 20px 0px; text-align: right">
									<h6>Tổng thanh toán:</h6>
								</td>
								<td rowspan="1" class="next-table-header-node" style="padding: 20px 20px; ">
									<h5 id="totalpricecart" th:text="${#numbers.formatInteger(totalAmount, 0, 'POINT') + ' đ'}" style="color: orangered; font-weight: bold;"></h5>
								</td>
								<td rowspan="1" class="next-table-header-node last" style="padding: 20px 0px 20px 0px; align-items: right">
									<form th:action="@{/shippinginformation}" method="post">
										<!-- Các trường form khác ở đây -->
										<input type="hidden" name="idSelectedCartItems" id="idSelectedCartItems">
										<button type="submit" class="btn btn-purchase">Mua hàng</button>
									</form>
								</td>
							</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
    </div>

    <script th:inline="javascript">
		function increaseQuantity(itemId, maxQuantity) {
			var quantityInput = document.getElementById("quantity_" + itemId);
			if (quantityInput) {
				var oldQuantity = parseInt(quantityInput.value);
				var newQuantity = oldQuantity + 1;

				if (oldQuantity < maxQuantity) {
					quantityInput.value = newQuantity;
					updateCartItem(itemId, newQuantity);
				} else {
					displayAlert('Số lượng đã đạt giới hạn.', 'alert-danger');
				}
			}
		}

		function decreaseQuantity(itemId) {
			var quantityInput = document.getElementById("quantity_" + itemId);
			if (quantityInput) {
				var oldQuantity = parseInt(quantityInput.value);
				var newQuantity = oldQuantity - 1;

				if (oldQuantity > 1) {
					quantityInput.value = newQuantity;
					updateCartItem(itemId, newQuantity);
				}
			}
		}

		function updateCartItem(itemId, quantity) {
			// Gửi yêu cầu AJAX đến máy chủ để cập nhật số lượng sản phẩm trong giỏ hàng
			var xhr = new XMLHttpRequest();
			xhr.open("POST", "/webbookstore/updatecartitem", true);
			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4 && xhr.status === 200) {
					// Xử lý phản hồi từ server (nếu cần)
					// Tải lại trang sau khi cập nhật giỏ hàng
					location.reload();
				} else {
					console.error("Update cart item failed");
				}
			};
			xhr.send("itemId=" + itemId + "&quantity=" + quantity);
		}

		// Cập nhật trạng thái của hộp kiểm 'check-All' khi 'checkAll' thay đổi
		var checkAll = document.getElementById('checkAll');
		if (checkAll) {
			checkAll.addEventListener('change', function() {
				var check_All = document.getElementById('check-All');
				if (check_All) {
					check_All.checked = this.checked;
				}
			});
		}

		// Cập nhật trạng thái của hộp kiểm 'checkAll' khi 'check-All' thay đổi
		var check_All = document.getElementById('check-All');
		if (check_All) {
			check_All.addEventListener('change', function() {
				var checkAll = document.getElementById('checkAll');
				if (checkAll) {
					checkAll.checked = this.checked;
				}
			});
		}

		// Chọn hoặc bỏ chọn tất cả quyển sách trong giỏ hàng khi 'checkAll' hoặc 'check-All' thay đổi
		document.querySelectorAll('#checkAll, #check-All').forEach(function(checkbox) {
			checkbox.addEventListener('change', function() {
				var checkboxes = document.getElementsByClassName('itemCheckbox');
				for (var i = 0; i < checkboxes.length; i++) {
					checkboxes[i].checked = this.checked;
				}
				var checkAll = document.getElementById('checkAll');
				if (checkAll) {
					checkAll.checked = this.checked;
				}
				var check_All = document.getElementById('check-All');
				if (check_All) {
					check_All.checked = this.checked;
				}
				updateTotalPrice();
			});
		});

		// Kiểm tra xem tất cả các hộp kiểm có được chọn không
		function checkAllSelected() {
			var checkboxes = document.getElementsByClassName('itemCheckbox');
			for (var i = 0; i < checkboxes.length; i++) {
				if (!checkboxes[i].checked) {
					return false;
				}
			}
			return true;
		}

		// Cập nhật trạng thái của hộp kiểm 'checkAll' và 'check-All' mỗi khi trạng thái của một hộp kiểm thay đổi
		document.querySelectorAll('.itemCheckbox').forEach(function(checkbox) {
			checkbox.addEventListener('change', function() {
				var allSelected = checkAllSelected();
				var checkAll = document.getElementById('checkAll');
				if (checkAll) {
					checkAll.checked = allSelected;
				}
				var check_All = document.getElementById('check-All');
				if (check_All) {
					check_All.checked = allSelected;
				}
				updateTotalPrice();
			});
		});


		// Lưu trạng thái checkbox khi trang được tải lại
		window.addEventListener('unload', function() {
			// Kiểm tra nếu giỏ hàng trống
			var checkAll = document.getElementById('checkAll');
			var cartIsEmpty = (checkAll === null);
			if (cartIsEmpty) {
				// Xóa hết các checkbox đã được lưu
				sessionStorage.removeItem('checkedItems');
				sessionStorage.removeItem('checkAllChecked');
				sessionStorage.removeItem('check_AllChecked');
			} else {
				var checkedItems = Array.from(document.querySelectorAll('.itemCheckbox:checked')).map(checkbox => checkbox.dataset.itemId);
				sessionStorage.setItem('checkedItems', JSON.stringify(checkedItems));
				// Lưu trạng thái của hộp kiểm 'checkAll' và 'check-All'
				var checkAllChecked = checkAll.checked;
				sessionStorage.setItem('checkAllChecked', checkAllChecked);
				var check_AllChecked = document.getElementById('check-All').checked;
				sessionStorage.setItem('check_AllChecked', check_AllChecked);
			}
		});

		// Khôi phục trạng thái checkbox khi trang được tải
		window.addEventListener('load', function() {
			var checkedItems = JSON.parse(sessionStorage.getItem('checkedItems')) || [];
			checkedItems.forEach(function(itemId) {
				var checkbox = document.querySelector(`.itemCheckbox[data-item-id="${itemId}"]`);
				if (checkbox) checkbox.checked = true;
			});

			// Kiểm tra xem tất cả các mục có được chọn không
			var allItems = Array.from(document.querySelectorAll('.itemCheckbox'));
			var allItemsChecked = allItems.every(function(checkbox) {
				return checkbox.checked;
			});

			// Khôi phục trạng thái của hộp kiểm 'checkAll' và 'check-All'
			var checkAll = document.getElementById('checkAll');
			if (checkAll) {
				checkAll.checked = allItemsChecked;
			}
			var check_All = document.getElementById('check-All');
			if (check_All) {
				check_All.checked = allItemsChecked;
			}

			updateTotalPrice();
		});

		function updateTotalPrice() {
			var totalPrice = Array.from(document.querySelectorAll('.itemCheckbox:checked')).reduce(function(total, checkbox) {
				var price = parseFloat(checkbox.dataset.price);
				var quantity = parseInt(checkbox.dataset.quantity);
				if (isNaN(price)) {
					price = 0;
				}
				if (isNaN(quantity)) {
					quantity = 0;
				}
				return total + price * quantity;
			}, 0);
			var totalpricecart = document.querySelector('#totalpricecart');
			if (totalpricecart) {
				totalpricecart.textContent = totalPrice.toLocaleString('vi-VN', {style : 'currency', currency : 'VND'});
			}
		}

		// Gọi hàm updateTotalPrice() mỗi khi số lượng hoặc trạng thái checkbox thay đổi
		document.querySelectorAll('.itemCheckbox, .item-quantity').forEach(function(element) {
			element.addEventListener('change', updateTotalPrice);
		});

		// Gọi hàm updateTotalPrice() ngay sau khi trang được tải để hiển thị tổng giá tiền ban đầu
		window.addEventListener('load', function() {
			var checkedItems = JSON.parse(sessionStorage.getItem('checkedItems')) || [];
			checkedItems.forEach(function(itemId) {
				var checkbox = document.querySelector(`.itemCheckbox[data-item-id="${itemId}"]`);
				if (checkbox) checkbox.checked = true;
			});
			updateTotalPrice();
		});

		// Lưu danh sách các cartitem ID đã được check khi người dùng nhấn nút "Mua hàng"
		var btnPurchase = document.querySelector('.btn-purchase');
		if (btnPurchase) {
			btnPurchase.addEventListener('click', function(event) {
				event.preventDefault(); // Ngăn chặn hành vi mặc định của nút
				var idSelectedCartItems = Array.from(document.querySelectorAll('.itemCheckbox:checked')).map(checkbox => checkbox.dataset.itemId);

				// Cập nhật giá trị của trường ẩn với danh sách các ID đã chọn
				var idSelectedCartItemsInput = document.getElementById('idSelectedCartItems');
				if (idSelectedCartItemsInput) {
					idSelectedCartItemsInput.value = idSelectedCartItems.join(',');
				}

				// Gửi form
				event.target.form.submit();
			});
		}

	</script>

	<!-- Xử lý xóa từng cartitem bất đồng bộ-->
	<script th:inline="javascript">
		// Lấy phần tử hiển thị tổng số quyển sách còn hàng
    	var totalAvailableElement = document.querySelector(".form-cart-total-avail span");
    	// Lấy phần tử hiển thị tổng số sản phẩm không có sẵn
    	var totalUnavailableElement = document.querySelector(".form-cart-total-unavail span");

		document.addEventListener("DOMContentLoaded", function() {
			var deleteButtons = document.querySelectorAll('.delete-btn');
			deleteButtons.forEach(function(button) {
				button.addEventListener('click', function() {
					var cartItemId = button.dataset.cartItemId;
					var cartItemType = button.dataset.cartItemType; // Lấy giá trị của thuộc tính
					// Xóa cart item khỏi DOM
					button.closest('tr').remove(); // Tìm phần tử cha <tr> gần nhất và xóa nó
					// Giảm tổng số sản phầm (còn hàng và không có sẵn)
					if (totalAvailableElement && cartItemType === 'Available') {
						totalAvailableElement.textContent = parseInt(totalAvailableElement.textContent) - 1; // Giảm giá trị cho cart items "Available"
					}
					if (totalUnavailableElement && cartItemType === 'Unavailable') {
						totalUnavailableElement.textContent = parseInt(totalUnavailableElement.textContent) - 1; // Giảm giá trị cho cart items "Unavailable"
					}

					// Gửi yêu cầu xóa đến backend
					var xhr = new XMLHttpRequest();
					xhr.open('GET', '/webbookstore/removefromcart?itemId=' + cartItemId);
					xhr.onload = function() {
						if (xhr.status === 200) {
							// Kiểm tra nếu tổng số sản phẩm (còn hàng và không có sẵn) bằng 0
							if (totalAvailableElement && totalUnavailableElement && parseInt(totalAvailableElement.textContent) === 0 && parseInt(totalUnavailableElement.textContent) === 0) {
								window.location.reload(); // Tải lại trang giỏ hàng
							}
							// Kiểm tra nếu tổng số sản phẩm còn hàng bằng 0 và sp không có sẵn là null
							if (totalAvailableElement && !totalUnavailableElement && parseInt(totalAvailableElement.textContent) === 0) {
								window.location.reload(); // Tải lại trang giỏ hàng
							}
							// Kiểm tra nếu tổng số sản phẩm còn hàng là null và sp không có sẵn bằng 0
							if (!totalAvailableElement && totalUnavailableElement && parseInt(totalUnavailableElement.textContent) === 0) {
								window.location.reload(); // Tải lại trang giỏ hàng
							}
						} else {
							// Hiển thị thông báo lỗi
							var errorMessage = xhr.responseText || 'Đã có lỗi xảy ra. Vui lòng tải lại trang, hoặc đăng nhập lại.';
							updateErrorMessage(errorMessage);
						}
					};
					xhr.onerror = function() {
						console.error('Request failed');
					};
					xhr.send();
				});
			});

			function updateErrorMessage(message) {
				var alertDiv = document.getElementById('myAlert01');
				if (alertDiv) {
					alertDiv.textContent = message;
					if (message.includes('thành công')) {
						alertDiv.classList.remove('alert-danger');
						alertDiv.classList.add('alert-success');
					} else {
						alertDiv.classList.remove('alert-success');
						alertDiv.classList.add('alert-danger');
					}
				}
			}
		});
	</script>
	<script>
		var myAlert02 = document.getElementById('myAlert02'); // Tránh bị null
		// Đặt thời gian cho alert
		if (myAlert02){
			setTimeout(function() {
            document.getElementById('myAlert02').style.display = 'none';
        	}, 10000);  // Alert sẽ biến mất sau 10 giây
		}
	</script>
	<script>
		document.querySelectorAll('.item-quantity').forEach(function(input) {
            input.addEventListener('change', function() {
                var itemId = this.dataset.itemId;
                var maxQuantity = parseInt(this.dataset.maxQuantity);
                var newQuantity = parseInt(this.value);

                // Kiểm tra xem số lượng mới có hợp lệ không
                if (newQuantity > 0 && newQuantity <= maxQuantity) {
                    // Cập nhật số lượng sản phẩm
                    updateCartItem(itemId, newQuantity);
                } else if (newQuantity > maxQuantity) {
                    // Nếu số lượng mới vượt quá số lượng tối đa, đặt lại số lượng về giá trị lớn nhất cho phép
                    this.value = maxQuantity;
                    var message =  'Số lượng không hợp lệ. Vui lòng nhập một số từ 1 đến ' + maxQuantity + '.';
                    displayAlert(message, 'alert-danger');
                } else {
                    // Nếu số lượng mới không hợp lệ (như một kí tự không phải số hoặc một số âm), đặt lại số lượng về 1
                    this.value = 1;
                }
            });
        });

        function displayAlert(message, alertType) {
            // Kiểm tra xem đã có thông báo chưa
            if (document.getElementById('myAlert02')) {
                return;
            }

            var alertBox = document.createElement('div');
            alertBox.className = 'alert ' + alertType;
            alertBox.id = 'myAlert02';
            alertBox.style.fontWeight = 'bold';
            alertBox.style.justifyContent = 'center';
            alertBox.style.display = 'flex';

            var alertText = document.createElement('span');
            alertText.textContent = message;

            alertBox.appendChild(alertText);

            // Tìm phần tử header và chèn thông báo ngay sau nó
            var header = document.getElementsByTagName('header')[0];
            header.parentNode.insertBefore(alertBox, header.nextSibling);

            // Thông báo sẽ tự động biến mất sau 10 giây
            setTimeout(function() {
                alertBox.remove();
            }, 10000);
        }
	</script>

	<!-- Xử lý xóa các món hàng đang được tick chọn (xóa bất đồng bộ)-->
	<script>
		// Lấy phần tử hiển thị tổng số quyển sách còn hàng
    	var totalAvailableElement = document.querySelector(".form-cart-total-avail span");
    	// Lấy phần tử hiển thị tổng số sản phẩm không có sẵn
    	var totalUnavailableElement = document.querySelector(".form-cart-total-unavail span");

		document.getElementById('deleteSelected').addEventListener('click', function() {
			// Lấy tất cả các checkbox
			var checkboxes = document.querySelectorAll('.itemCheckbox');

			// Tạo một mảng để lưu trữ tất cả các promise
			var promises = [];

			// Lặp qua tất cả các checkbox
			for (var i = 0; i < checkboxes.length; i++) {
				var checkbox = checkboxes[i];

				// Kiểm tra xem checkbox có được chọn không
				if (checkbox.checked) {
					// Giảm tổng số sản phẩm (còn hàng và không có sẵn)
					var cartItemId = checkbox.dataset.itemId;
					var cartItemType = checkbox.dataset.cartItemType; // Lấy giá trị của thuộc tính
					// Xóa cart item khỏi DOM
					checkbox.closest('tr').remove();
					// Giảm tổng số sản phẩm (còn hàng và không có sẵn)
					if (totalAvailableElement && cartItemType === 'Available') {
						totalAvailableElement.textContent = parseInt(totalAvailableElement.textContent) - 1; // Giảm giá trị cho cart items "Available"
					}
					if (totalUnavailableElement && cartItemType === 'Unavailable') {
						totalUnavailableElement.textContent = parseInt(totalUnavailableElement.textContent) - 1; // Giảm giá trị cho cart items "Unavailable"
					}

					// Tạo một promise mới cho mỗi yêu cầu xóa
					var promise = new Promise(function(resolve, reject) {
						// Gửi yêu cầu xóa đến server
						var xhr = new XMLHttpRequest();
						xhr.open('GET', '/webbookstore/removefromcart?itemId=' + cartItemId);
						xhr.onload = function() {
							if (xhr.status === 200) {
								// Xóa thành công, giải quyết promise
								resolve();
							} else {
								// Có lỗi xảy ra, từ chối promise
								reject('Delete request failed');
							}
						};
						xhr.onerror = function() {
							reject('Request failed');
						};
						xhr.send();
					});

					// Thêm promise vào mảng
					promises.push(promise);
				}
			}

			// Chờ cho đến khi tất cả các promise hoàn thành
			Promise.all(promises).then(function() {
				// Kiểm tra nếu tổng số sản phẩm (còn hàng và không có sẵn) bằng 0
				if (totalAvailableElement && totalUnavailableElement && parseInt(totalAvailableElement.textContent) === 0 && parseInt(totalUnavailableElement.textContent) === 0) {
					window.location.reload(); // Tải lại trang giỏ hàng
				}
				// Kiểm tra nếu tổng số sản phẩm còn hàng bằng 0 và sp không có sẵn là null
				if (totalAvailableElement && !totalUnavailableElement && parseInt(totalAvailableElement.textContent) === 0) {
					window.location.reload(); // Tải lại trang giỏ hàng
				}
				// Kiểm tra nếu tổng số sản phẩm còn hàng là null và sp không có sẵn bằng 0
				if (!totalAvailableElement && totalUnavailableElement && parseInt(totalUnavailableElement.textContent) === 0) {
					window.location.reload(); // Tải lại trang giỏ hàng
				}
			}).catch(function(error) {
				// Hiển thị thông báo lỗi
				var errorMessage = xhr.responseText || 'Đã có lỗi xảy ra. Vui lòng tải lại trang, hoặc đăng nhập lại.';
				updateErrorMessage(errorMessage);
			});
		});
	</script>


	<div th:replace="~{layout/footer :: footer}"></div>
	<!-- Thêm các tệp tin JavaScript -->
    <script th:src="@{/js/jquery-3.4.1.slim.min.js}"></script>
    <script th:src="@{/js/popper.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thông tin vận chuyển</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

	<!--Thêm đoạn javascript bên dưới để có thể thực hiện dropdown Account	?\\-->
	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

	<!-- Popper JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

	<style>

		body { background-color: #f8f9fa  }

		h3 {
        	text-align: center;
        	margin-top: 10px;
        	margin-bottom: 20px;
        	color: rgb(2,88,155);
    	}
    	.form-container {
	        border-radius: 15px;
	        margin-top: 40px;
        	margin-bottom: 40px;
	    }
<!--	    .btn-cancle {-->
<!--			border: 2px solid rgb(241,56,71);-->
<!--			color: rgb(0, 0, 0);-->
<!--			border-radius: 10px;-->
<!--		}-->
<!--		.btn-cancle:hover {-->
<!--			color: rgb(255, 0, 0);-->
<!--		}-->

		.btn-order {
			background-color: #3448c5;
			border-radius: 50px;
			color: white;
			width: 200px;
			box-shadow: 0px 4px 6px rgba(0, 0.4, 0, 0.2);
		}
		.btn-order:hover {
			background-color: #211f7f;
			color: white;
			box-shadow: 0px 6px 8px rgba(0, 0.4, 0, 0.2);
		}

		.frame {
			background-color:#dbdbdb;
			border-radius: 10px;
			height: 50px;
			margin-top: 20px;
        	margin-bottom: 20px;
        	display: flex;
		    justify-content: flex-end;
		    align-items: center;
		    padding: 10px;
		}
		.text-total {
			text-align: center;
		}
		.navbar-nav {
			display: frex;
		}
		.navbar-nav-left {
			width: 70%;
		}
		.navbar-nav-right {
			width: 30%;
		}
		.nav-link {
			display: flex;
      		align-items: center;
      		column-gap: 0.5rem;
      		width: fit-content;
		}
		.move-right {
			margin-left: auto;
			display: flex;
			float: right;
		}
		.material-symbols-outlined{
			color: rgb(2,88,155);
		}

		.form-container {
			box-shadow: 0 8px 10px rgb(226, 226, 226);

		}

		.material-symbols-outlined.back {
			color: rgb(2,88,155);
		}

		.material-symbols-outlined.back:hover {
			color: rgb(182,232,241);
		}

		.form-group.row {
			width: 360px;
			margin: 0px;
			margin-top: 10px;
		}

		.col-info {
			width: 323px;
		}

		.my-custom-modal .modal-dialog {
            margin-top: 150px;
        }

		.my-custom-modal .modal-body {
			max-height: 400px;  /* Đặt chiều cao tối đa cho phần body của modal */
			overflow-y: auto;   /* Thêm thanh cuộn dọc nếu nội dung vượt quá chiều cao tối đa */
		}

	</style>
</head>
<body>
	<div th:replace="~{layout/header :: header}"></div>
    <div class="container-fluid mb-4">
        

		<div class="container" style="padding: 0px">
			<div class="form-container" style="background-color: white; padding: 20px">
				<div class="row-00 d-flex align-items-center" style="height: 30px; margin-bottom: 15px; margin: 0px 0px 0px; border-bottom: 1px solid #cecece; padding-bottom: 10px">
					<div class="col-00" style="display: flex; align-items: center;">
						<a th:href="@{/viewcart}" class="before" style="align-items: center; display: flex; text-decoration: none;">
							<span class="material-symbols-outlined back">arrow_back_ios</span>
						</a>
						<h6 style="color: #211f7f; align-items: center;  margin: 0px 5px 0px 0px; font-family: Verdana; font-weight: bold">Thanh toán</h6>
					</div>
				</div>

				<!-- Nếu addresses rỗng, chỉ hiển thị nút Thêm địa chỉ -->
				<div th:unless="${addresses != null && addresses.size() > 0}">
					<p>Vui lòng thêm thông tin địa chỉ để có thể đặt hàng!</p>
					<a th:href="@{/addaddress}" class="btn btn-success">Thêm địa chỉ</a>
				</div>

		        <form th:if="${addresses != null && addresses.size() > 0}" id="myForm" th:action="@{/placeorder}" method="post" style="width: 100%">
					<div class="row-01 d-flex justify-content-center" style="width: 100%; border-bottom: 1px solid #cecece;">
						<div class="col-01" style="width: 65%; padding-right: 20px; border-right: 1px solid #cecece; padding-bottom: 15px">
							<div class="row-001 d-flex align-items-center" style="padding: 20px 0px 20px 0px;">
								<h6 class="text-left" style="margin: 0px">Quyển sách đã chọn</h6>
								<div class="form-cart" th:if="${selectedCartItems != null}"
									 style="color: orangered; align-items: center; font-weight: 500; d-flex align-items-center; margin-left: 5px">
									<p style="margin: 0px 0px 0px">
										<span th:text="'(' + ${selectedCartItems.size()} + ' quyển sách)'"></span>
									</p>
								</div>
							</div>
							<table>
								<thead>
								<tr style="width: 100%; height: 50px; border-top: 1px solid #cecece; background-color: #f2f5f6; margin-top: 10px" >
									<th class="align-middle text-center" style="width: 50%; text-align: center; padding: 0px 10px">Tên sách</th>
									<th class="align-middle text-center" style="width: 10%; text-align: center; padding: 0px 10px">Số lượng</th>
									<th class="align-middle " style="width: 20%; text-align: right; padding: 0px 10px">Giá</th>
									<th class="align-middle " style="width: 20%; text-align: right; padding: 0px 10px">Tổng cộng</th>
								</tr>
								</thead>
								<tbody>
								<tr th:each="cartItem : ${selectedCartItems}" onmouseover="this.style.backgroundColor='#f2f5f6';" onmouseout="this.style.backgroundColor='transparent';"
									style="border-top: 1px solid #cecece; background-color: transparent;">
									<td th:text="${cartItem.book.name}" class="align-middle" style="text-align: center; padding: 10px 0px"></td>
									<td th:text="${cartItem.quantity}" class="align-middle text-center" style="text-align: center; padding: 10px 0px"></td>
									<td th:text="${#numbers.formatInteger(cartItem.book.sellPrice, 0, 'POINT')+ ' đ'}" class="align-middle" style="text-align: right; padding: 10px 10px"></td>
									<td th:text="${#numbers.formatInteger(cartItem.quantity * cartItem.book.sellPrice, 0, 'POINT')+ ' đ'}" class="align-middle" style="text-align: right; padding: 10px 10px"></td>
								</tr>
								</tbody>
							</table>
							<div class="frame" style="background-color: #ffebae;">
								<div class="text-total" >
									<h6 style="margin: 0px; font-weight: bold; ">Tổng thanh toán: <span th:text="${#numbers.formatInteger(totalAmount, 0, 'POINT') + ' đ'}" style="color: orangered; "></span></h6>
								</div>
							</div>
						</div>
						<!-- Nếu addresses không rỗng, hiển thị các input -->
						<div class="col-02" style="width: 35%; padding-left: 20px; padding-bottom: 15px">
							<h6 class="text-left" style="padding: 20px 0px 10px 0px; margin: 0px">Địa chỉ nhận hàng</h6>
							<div class="form-group row d-flex align-items-center" style="border-radius: 50px; border: 1px solid #cecece;">
								<span class="material-symbols-outlined" style="color: grey; margin: 5px">person_2</span>
								<div class="col-info">
									<input type="text" id="name" name="name" th:value="${addresses[0].recipientName}" required class="form-control"
										   style="border-radius: 50px; padding: 6px 0px; border: none;">
								</div>
							</div>

							<div class="form-group row d-flex align-items-center" style="border-radius: 50px; border: 1px solid #cecece;">
								<span class="material-symbols-outlined" style="color: grey; margin: 5px">location_on</span>
								<div class="col-info">
									<input type="text" id="address" name="address" th:value="${account.address}" required class="form-control"
										   style="border-radius: 50px; padding: 6px 0px; border: none;">
								</div>
							</div>
							<div class="form-group row d-flex align-items-center" style="border-radius: 50px; border: 1px solid #cecece;">
								<span class="material-symbols-outlined" style="color: grey; margin: 5px">call</span>
								<div class="col-info">
									<input type="text" id="phoneNumber" name="phoneNumber" th:value="${addresses[0].phoneNumber}" required class="form-control"
										   style="border-radius: 50px; padding: 6px 0px; border: none;">
								</div>
							</div>
							<div class="form-group row d-flex align-items-center" style="border-radius: 50px; border: 1px solid #cecece;">
								<span class="material-symbols-outlined" style="color: grey; margin: 5px">mail</span>
								<div class="col-info">
									<input type="email" id="email" name="email" th:value="${account.email}" required class="form-control"
										   style="border-radius: 50px; padding: 6px 0px; border: none;">
								</div>
							</div>
							<!-- Button trigger modal -->
							<button type="button" class="btn btn-warning change-address-btn" data-toggle="modal" data-target="#changeAddressModal" th:attr="data-id=${addresses[0].id}">
								Chọn địa chỉ có sẵn
							</button>

						</div>

					</div>

		            <div class="form-group row-01" style="padding-bottom: 10px;">
						<div class="row-01 d-flex align-items-center">
							<span class="material-symbols-outlined" style="color: #5390f5; margin-right: 5px">paid</span>
							<label for="paymentMethods" class="col col-form-label" style="padding: 10px 0px; color: #5390f5; font-weight: bold">
								Phương thức thanh toán:
							</label>
						</div>
						<div class="row-02 d-flex align-items-center" style="width: 100%">
							<div class="col-001" style="width: 30%; border: 1px solid #cecece; border-radius: 50px;">
								<select id="paymentMethods" name="paymentMethods" class="form-control" style="border: none; border-radius: 50px" onchange="changeIcon(this.value)">
									<option value="cash"> Thanh toán khi nhận hàng</option>
									<option value="VNPAY">Cổng thanh toán VNPAY</option>
								</select>
							</div>
							<div class="col-002 d-flex align-items-center justify-content-center" style="width: 70%; padding-left: 20px">
								<img id="paymentIcon" src="https://res.cloudinary.com/dylwewmt0/image/upload/v1713775052/PHOTO_LIST/shippinginfomation/cash02.png" height="38" style="margin-right: 10px">
								<p style="margin: 0px; font-weight: 600">-  Bạn chỉ nên nhận hàng khi trạng thái</p>
								<h5 style="margin: 0px 10px 0px 10px; color: #5390f5;">"ĐANG GIAO HÀNG"</h5>
								<p style="margin: 0px; font-weight: 600">được cập nhật</p>
							</div>
						</div>
		            </div>
					<div class="text-center">
						<input type="hidden" name="idSelectedCartItems" id="idSelectedCartItems" th:value="${idSelectedCartItems}">
						<button type="submit" class="btn btn-order">Đặt hàng</button>
					</div>
		        </form>
			</div>
		</div>
    </div>

	<!-- Modal hiển thị pop up để chọn địa chỉ khác -->
	<div  th:if="${addresses != null && addresses.size() > 0}"  class="modal fade my-custom-modal" id="changeAddressModal" tabindex="-1" role="dialog" aria-labelledby="changeAddressModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="changeAddressModalLabel">Chọn địa chỉ</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div class="modal-body">
					<!-- Đặt giá trị của addresses[0].id vào thuộc tính data-id của form -->
					<form id="changeAddressForm" th:attr="data-id=${addresses[0].id}">
						<div th:each="address : ${addresses}">
							<div class="card mb-3">
								<div class="card-body">
									<input type="radio" name="addressId" th:value="${address.id}" th:checked="${address.id == addresses[0].id}">
									<p class="card-text">
										<span class="recipientName" th:text="${address.recipientName}"></span> - <span class="phoneNumber" th:text="${address.phoneNumber}"></span>
									</p>
									<p class="card-text">
										<span class="cityName" th:text="${address.city.name}"></span>, <span class="districtName" th:text="${address.district.name}"></span>, <span class="wardName" th:text="${address.ward.name}"></span>
									</p>
									<p class="card-text">
										<span class="addressDetails" th:text="${address.addressDetails}"></span>
									</p>
									<p class="card-text">
										<span th:text="${address.addressNote}"></span>
									</p>
									<p class="card-text">
										Loại địa chỉ: <span th:text="${address.addressType == 0 ? 'Văn phòng' : 'Nhà'}"></span>
									</p>
									<p class="card-text">
										Mặc định: <span th:text="${address.isDefault == 1 ? 'Có' : 'Không'}"></span>
									</p>
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<!-- Thêm nút "Thêm địa chỉ" -->
					<a th:href="@{/addaddress}" class="btn btn-success">Thêm địa chỉ</a>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
					<button type="button" class="btn btn-primary" id="changeAddressConfirm">Chọn</button>
				</div>
			</div>
		</div>
	</div>

    <div th:replace="~{layout/footer :: footer}"></div>
	<script>
		function changeIcon(paymentMethod) {
            var paymentIcon = document.getElementById('paymentIcon');
            if (paymentMethod == 'cash') {
                paymentIcon.src = 'https://res.cloudinary.com/dylwewmt0/image/upload/v1713775052/PHOTO_LIST/shippinginfomation/cash02.png';
            } else if (paymentMethod == 'VNPAY') {
                paymentIcon.src = 'https://res.cloudinary.com/dylwewmt0/image/upload/v1713774779/PHOTO_LIST/shippinginfomation/VNPAY.png';
            }
        }
	</script>

	<script>
		$(document).ready(function() {
			// Lấy id của địa chỉ đang được chọn từ thuộc tính data-id của form
			var currentAddressId = $('#changeAddressForm').data('id');

			$('#changeAddressConfirm').click(function() {
				var selectedAddressId = $('input[name="addressId"]:checked').val();
				if (selectedAddressId) {
					// Cập nhật id của địa chỉ đang được chọn
					currentAddressId = selectedAddressId;

					// Cập nhật địa chỉ nhận hàng trên giao diện
					var selectedAddress = $('input[name="addressId"]:checked').closest('.card-body');
					$('#name').val(selectedAddress.find('.recipientName').text());
					$('#phoneNumber').val(selectedAddress.find('.phoneNumber').text());
					$('#address').val(selectedAddress.find('.addressDetails').text() + ', ' +
									  selectedAddress.find('.wardName').text() + ', ' +
									  selectedAddress.find('.districtName').text() + ', ' +
									  selectedAddress.find('.cityName').text());

					// Gửi yêu cầu đến máy chủ để cập nhật địa chỉ nhận hàng
					// ...

					// Đóng modal
					$('#changeAddressModal').modal('hide');
				}
			});

			// Khi mở modal, chọn radio button tương ứng với địa chỉ đang được chọn
			$('#changeAddressModal').on('show.bs.modal', function() {
				$('input[name="addressId"][value="' + currentAddressId + '"]').prop('checked', true);
			});
		});

	</script>

<!--	<script>-->
<!--		// Lắng nghe sự kiện click vào nút "Đặt hàng"-->
<!--		$(".btn-order").click(function() {-->
<!--			// Submit form-->
<!--			$("#myForm").submit();-->
<!--		});-->
<!--	</script>-->
</body>
</html>